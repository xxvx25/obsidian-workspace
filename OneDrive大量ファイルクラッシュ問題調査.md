# OneDrive Macアプリ大量ファイルクラッシュ問題調査

## 調査日時
2024年12月3日

## 調査結果サマリー

### 確認された重大な問題

1. **システムの強制終了やカーネルパニック**
   - **問題**: 小さなファイルを大量にダウンロードする際、システムが強制終了する
   - **影響**: システム全体がクラッシュする可能性がある
   - **報告例**: 数万件のファイルを一度に処理する場合に発生

2. **OneDriveアプリの再起動ループ**
   - **問題**: OneDriveが数秒ごとに起動と終了を繰り返す
   - **影響**: ゴミ箱に不要なファイルを大量に生成する
   - **報告時期**: 2024年5月に報告された問題

3. **macOS 15 Sequoiaでのフリーズ問題**
   - **問題**: デスクトップやドキュメントフォルダ内のファイルを開いたり保存したりすると、アプリケーションがフリーズする
   - **影響**: 特定のプロセスが高いCPU使用率を示す
   - **修正状況**: macOS 15.2へのアップデートで解消された（2025年1月時点）
   - **現在の状況**: 現在のシステム（macOS 15.7.2）では修正済みの可能性が高い

4. **ファイルオンデマンド機能の問題**
   - macOS 12.1以降では、OneDriveのファイルオンデマンド機能がmacOSの一部として統合され、オフにすることができない
   - この変更により、ファイルの同期方法や挙動が変わり、特定の状況で問題が発生する可能性がある

5. **大量ファイルの同期に関する問題**
   - 過去にはOneDriveの新バージョンで、ローカルに保存されていたファイルが大量に失われるという問題も報告されていた
   - これは、ファイルオンデマンド機能がデフォルトで有効になったことによるもの

### 現在のシステム情報

- **macOSバージョン**: 15.7.2 (24G325)
- **OneDriveバージョン**: 25.206.1021
- **クラッシュログ**: 現在のクラッシュログバッファは空（最近のクラッシュはないか、既に送信済み）

## 既知の制限と問題

### ファイル数の制限

OneDriveには以下のような制限があります：

1. **同期可能なファイル数**
   - 公式には明確な制限は公表されていないが、実用的には数万ファイルまで
   - 大量のファイル（1万個以上）を一度に変更すると、パフォーマンスの問題が発生する可能性がある

2. **メモリ使用量**
   - 大量のファイルを同期する際、メモリ使用量が増加する
   - メモリ不足によりクラッシュする可能性がある

3. **同期のパフォーマンス**
   - 大量のファイル変更を一度に処理すると、同期が遅くなる
   - アプリケーションが応答しなくなる（フリーズ）可能性がある

## 推奨される対処方法

### 1. OneDriveアプリを最新版に更新

```bash
# OneDriveのバージョンを確認
defaults read com.microsoft.OneDrive-mac SessionVersion

# 最新版に更新するには、App StoreまたはMicrosoft公式サイトから更新
```

### 2. 大量ファイル操作を分割する

- 1万個以上のファイルを一度に変更する場合は、小さいバッチに分割する
- 例: 1000個ずつ処理する

### 3. ファイルオンデマンド機能の設定を確認

- 重要なファイルは「このデバイス上に常に保持する」オプションを選択
- 大量のファイルを一度にダウンロードしない

### 4. メモリ使用量を監視

```bash
# OneDriveのメモリ使用量を確認
ps aux | grep -i onedrive | grep -v grep
```

### 5. 同期を一時停止してから操作

- 大量のファイル変更を行う前に、OneDriveの同期を一時停止
- 変更完了後、同期を再開

## クラッシュログの確認方法

### システムログの確認

```bash
# OneDrive関連のクラッシュログを確認
log show --predicate 'process == "OneDrive" OR process == "OneDrive-mac"' --last 7d | grep -i crash

# クラッシュレポートの確認
ls -la ~/Library/Logs/DiagnosticReports/ | grep -i onedrive
```

### アプリケーションログの確認

```bash
# OneDriveのログファイルを確認
find ~/Library/Containers/com.microsoft.OneDrive-mac -name "*.log" 2>/dev/null
```

## バグレポートの提出方法

問題が発生した場合：

1. **Microsoftサポートに報告**
   - https://support.microsoft.com/onedrive
   - クラッシュログと再現手順を添付

2. **フィードバックの送信**
   - OneDriveアプリのメニューバー → 設定 → フィードバックの送信

## 予防策

### 大量ファイル操作時のベストプラクティス

1. **バックアップを取る**
   - 操作前に必ずバックアップを取る

2. **小さいバッチで処理**
   - 大量のファイルを一度に変更しない
   - 1000-5000個ずつ処理する

3. **同期を一時停止**
   - 大量の変更を行う前に同期を一時停止
   - 変更完了後、段階的に同期を再開

4. **メモリの監視**
   - アクティビティモニタでメモリ使用量を監視
   - メモリ不足の場合は、他のアプリを終了

5. **最新版を使用**
   - OneDriveアプリを常に最新版に保つ
   - macOSも最新の状態に保つ

## 参考情報

- [Microsoft OneDrive サポート](https://support.microsoft.com/onedrive)
- [OneDrive for Mac の既知の問題](https://support.microsoft.com/onedrive)
- macOS 15 Sequoiaでの問題は修正済み（2025年1月時点）

## 結論

### 重要な発見

**✅ 確認された問題: OneDrive Macアプリは、大量のファイル（1万個レベル）を一度に変更すると、以下の深刻な問題が発生する可能性があります：**

1. **システム全体のクラッシュ（カーネルパニック）**
   - 小さなファイルを大量にダウンロードする際に発生
   - システム全体が不安定になる可能性がある

2. **アプリの再起動ループ**
   - 数秒ごとに起動と終了を繰り返す
   - ゴミ箱に不要なファイルを大量に生成

3. **フリーズ問題**
   - ファイルの開閉時にアプリがフリーズ
   - 高いCPU使用率によるパフォーマンス低下

### 現在の状況

- **macOS 15.7.2**: フリーズ問題は修正済みの可能性が高い
- **OneDrive 25.206.1021**: 最新版だが、大量ファイル処理の問題は完全には解決されていない可能性がある
- **推奨**: 大量のファイル操作を行う場合は、必ず上記の予防策を実施することを強く推奨します

### 特に注意すべき操作

⚠️ **以下の操作は特に注意が必要です：**
- 1万個以上のファイルを一度に削除
- 1万個以上のファイルを一度に移動
- 1万個以上のファイルを一度に同期
- 小さなファイルを大量にダウンロード

これらの操作は、システム全体のクラッシュを引き起こす可能性があります。

